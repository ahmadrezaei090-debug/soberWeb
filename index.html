<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی چیستان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
            overscroll-behavior: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .gold-gradient-text {
            background: linear-gradient(90deg, #FFD700, #F0C040, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .btn-golden {
            background: linear-gradient(145deg, #c39d1a, #e6c229, #c39d1a);
            color: #121212; font-weight: bold; border-radius: 12px;
            padding: 12px 24px; text-align: center; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
        }
        .btn-golden:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }
        .btn-golden:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);
        }
        .btn-golden.disabled {
            background: linear-gradient(145deg, #5c5c5c, #7a7a7a, #5c5c5c);
            color: #aaa; cursor: not-allowed; box-shadow: none; border-color: #666;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        .screen {
            display: none; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; overflow-y: auto;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .form-input {
             width: 100%; padding: 12px; background-color: rgba(0,0,0,0.3);
             border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;
             color: #E0E0E0; transition: all 0.3s;
        }
        .form-input:focus {
            outline: none; border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .timer-flash { animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        #falling-letters-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.15;
        }
        /* Search Animation */
        .search-container .dot {
            width: 20px; height: 20px; background: #FFD700;
            border-radius: 50%; margin: 0 10px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .search-container .dot:nth-child(1) { animation-delay: -0.32s; }
        .search-container .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* Profile Modal Animation */
        #profile-modal .card {
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease;
            transform: translateY(50px) scale(0.9);
            opacity: 0;
        }
        #profile-modal.active .card {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="overflow-hidden">
<canvas id="falling-letters-canvas"></canvas>

<!-- Auth Screen -->
<div id="auth-screen" class="screen p-8 flex flex-col justify-center items-center h-screen text-center">
    <div class="card p-8 max-w-sm w-full space-y-6">
        <h1 class="text-5xl font-black gold-gradient-text">چیستان</h1>
        <p class="text-gray-300">به دنیای چیستان‌ها خوش آمدید!</p>
        <div class="space-y-4">
            <button id="go-to-login-btn" class="w-full btn-golden text-xl">ورود</button>
            <button id="go-to-register-btn" class="w-full p-3 bg-gray-700 rounded-lg">ثبت نام</button>
        </div>
    </div>
</div>

<!-- Register Screen -->
<div id="register-screen" class="screen p-8 flex flex-col justify-center items-center h-screen">
    <div class="card p-8 max-w-sm w-full space-y-5">
        <h2 class="text-3xl font-bold gold-gradient-text text-center">ساخت حساب کاربری</h2>
        <input id="register-username" type="text" placeholder="نام کاربری" class="form-input">
        <input id="register-age" type="number" placeholder="سن" class="form-input">
        <input id="register-password" type="password" placeholder="رمز عبور" class="form-input">
        <input id="register-confirm-password" type="password" placeholder="تکرار رمز عبور" class="form-input">
        <p id="register-error" class="text-red-400 text-sm hidden"></p>
        <button id="register-btn" class="w-full btn-golden">ثبت نام</button>
        <button id="back-to-auth-from-register" class="w-full p-2 text-sm text-gray-400">بازگشت</button>
    </div>
</div>

<!-- Login Screen -->
<div id="login-screen" class="screen p-8 flex flex-col justify-center items-center h-screen">
    <div class="card p-8 max-w-sm w-full space-y-5">
        <h2 class="text-3xl font-bold gold-gradient-text text-center">ورود به حساب</h2>
        <input id="login-username" type="text" placeholder="نام کاربری" class="form-input">
        <input id="login-password" type="password" placeholder="رمز عبور" class="form-input">
        <p id="login-error" class="text-red-400 text-sm hidden"></p>
        <button id="login-btn" class="w-full btn-golden">ورود</button>
        <button id="back-to-auth-from-login" class="w-full p-2 text-sm text-gray-400">بازگشت</button>
    </div>
</div>

<!-- Main Menu Screen -->
<div id="main-menu-screen" class="screen p-6 flex flex-col h-screen">
    <header class="flex justify-between items-center mb-16">
        <div id="profile-header-btn" class="flex items-center space-x-4 space-x-reverse cursor-pointer">
            <div class="w-16 h-16 rounded-full bg-yellow-400/20 border-2 border-yellow-500 flex items-center justify-center text-3xl gold-gradient-text font-black" id="menu-avatar"></div>
            <div>
                <p id="menu-username" class="font-bold text-lg text-white"></p>
                <p id="menu-highscore" class="text-sm gold-gradient-text font-bold">🚀 بالاترین رکورد: 0</p>
            </div>
        </div>
        <button id="settings-btn" class="text-3xl">⚙️</button>
    </header>
    <main class="flex-grow flex flex-col justify-center items-center space-y-4">
        <button id="start-game-btn" class="w-full max-w-[280px] btn-golden text-xl py-3">بازی رکوردی</button>
        <button id="start-online-btn" class="w-full max-w-[280px] btn-golden text-xl py-3">بازی آنلاین</button>
    </main>
</div>

<!-- Gameplay Screen -->
<div id="gameplay-screen" class="screen p-6 flex flex-col h-screen">
    <header class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-2 space-x-reverse">
            <p class="text-red-400 text-3xl">❤️</p>
            <p id="lives-count" class="text-2xl font-bold text-white">3</p>
        </div>
        <div id="timer-display" class="hidden text-center card px-4 py-2"><p class="text-lg font-bold">زمان:</p><p id="timer-count" class="text-3xl font-black text-yellow-400">35</p></div>
        <div class="text-center"><p class="text-2xl font-bold gold-gradient-text">امتیاز: <span id="game-score">0</span></p></div>
    </header>
    <main class="flex-grow flex flex-col justify-center items-center text-center">
        <!-- Online Match Header -->
        <div id="online-match-header" class="hidden mb-4 text-center">
            <p class="text-lg">شما <span id="online-player-score" class="font-bold text-yellow-400">0</span> - <span id="online-bot-score" class="font-bold text-red-400">0</span> <span id="online-bot-name"></span></p>
            <p class="text-sm text-gray-400">راند <span id="online-round-count">1</span> از 2</p>
        </div>
        <div class="w-full max-w-lg card p-8">
            <p id="riddle-question" class="text-xl md:text-2xl mb-8 min-h-[100px] flex items-center justify-center"></p>
            <div id="options-container" class="grid grid-cols-2 gap-4"></div>
            <div id="input-container" class="hidden flex flex-col gap-4 w-full">
                <input type="text" id="flash-answer-input" placeholder="پاسخ را اینجا تایپ کنید..." class="form-input text-center text-lg">
                <button id="flash-submit-btn" class="w-full btn-golden text-xl py-3">ثبت پاسخ</button>
            </div>
        </div>
    </main>
</div>

<!-- Online Search Screen -->
<div id="online-search-screen" class="screen p-8 flex flex-col justify-center items-center text-center h-screen">
    <h2 class="text-3xl font-bold text-white mb-8">در حال جستجوی حریف...</h2>
    <div class="search-container flex">
        <div class="dot"></div> <div class="dot"></div> <div class="dot"></div>
    </div>
    <p id="opponent-found-text" class="text-2xl text-yellow-400 mt-12 opacity-0 transition-opacity duration-500"></p>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="hidden fixed inset-0 bg-black/80 flex justify-center items-center z-50">
     <div class="card p-6 rounded-lg w-11/12 max-w-md text-center space-y-4">
        <h2 class="text-2xl font-bold gold-gradient-text mb-4">پروفایل کاربری</h2>
        <div class="text-lg">
            <p>نام کاربری: <span id="profile-username" class="font-bold text-yellow-400"></span></p>
            <p>سن: <span id="profile-age" class="font-bold text-yellow-400"></span></p>
        </div>
        <div class="grid grid-cols-2 gap-4 text-center mt-4 p-4 bg-black/20 rounded-lg">
            <div><p class="font-bold text-xl text-yellow-400" id="profile-highscore">0</p><p class="text-sm">بیشترین امتیاز</p></div>
            <div><p class="font-bold text-xl text-green-400" id="profile-correct">0</p><p class="text-sm">پاسخ صحیح</p></div>
            <div><p class="font-bold text-xl text-red-400" id="profile-incorrect">0</p><p class="text-sm">پاسخ غلط</p></div>
            <div><p class="font-bold text-xl text-blue-400" id="profile-total-games">0</p><p class="text-sm">کل بازی‌ها</p></div>
            <div><p class="font-bold text-xl text-purple-400" id="profile-online-games">0</p><p class="text-sm">بازی آنلاین</p></div>
            <div><p class="font-bold text-xl text-orange-400" id="profile-online-wins">0</p><p class="text-sm">بردهای آنلاین</p></div>
        </div>
        <div class="flex space-x-4 space-x-reverse pt-4">
             <button id="logout-btn" class="w-full p-3 bg-red-800/80 rounded-lg hover:bg-red-700/80 transition-colors">خروج از حساب</button>
             <button id="close-profile-btn" class="w-full btn-golden">بستن</button>
        </div>
     </div>
</div>

<!-- Other Modals and Screens (Settings, Game Over, etc.) would go here -->
<!-- For brevity, I'll omit the ones that are unchanged from your original code -->
<div id="game-over-screen" class="screen p-8 flex flex-col justify-center items-center text-center h-screen">
    <div class="card p-8 rounded-lg w-11/12 max-w-md space-y-6">
        <h2 id="game-over-title" class="text-4xl font-black text-red-400">بازی تمام شد!</h2>
        <p id="game-over-subtitle" class="text-xl"></p>
        <div id="game-over-stats">
            <p class="text-xl">امتیاز شما: <span id="final-score" class="text-yellow-400 font-bold"></span></p>
            <p class="text-lg mt-2">بالاترین رکورد: <span id="final-highscore" class="text-gray-300 font-bold"></span></p>
        </div>
        <div class="flex space-x-4 space-x-reverse">
            <button id="play-again-btn" class="w-full btn-golden">بازی مجدد</button>
            <button id="back-to-menu-gameover-btn" class="w-full p-3 bg-gray-700 rounded-lg">منوی اصلی</button>
        </div>
    </div>
</div>

<div id="mode-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
    <div class="card p-8 rounded-lg w-11/12 max-w-md text-center space-y-6">
        <h2 class="text-3xl font-bold gold-gradient-text mb-6">انتخاب حالت بازی رکوردی</h2>
        <button onclick="game.selectGameMode('old')" class="w-full btn-golden text-xl py-4 flex flex-col items-center">
            <span class="text-2xl font-black">2 Old (کلاسیک)</span>
            <span class="text-sm font-normal mt-1 text-gray-900">چند گزینه‌ای، بدون محدودیت زمانی</span>
        </button>
        <button onclick="game.selectGameMode('flash')" class="w-full btn-golden text-xl py-4 flex flex-col items-center">
            <span class="text-2xl font-black">2.5 Flash</span>
            <span class="text-sm font-normal mt-1 text-gray-900">سوالات سخت، تایپ پاسخ، زمان محدود</span>
        </button>
        <button id="close-mode-selection-btn" class="mt-4 w-full p-3 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition-colors">بازگشت</button>
    </div>
</div>

<script>
// --- App Structure ---
const App = {
    // ... All logic will be encapsulated here
};

// --- DOM Elements ---
const DOM = {
    screens: {
        auth: document.getElementById('auth-screen'),
        register: document.getElementById('register-screen'),
        login: document.getElementById('login-screen'),
        mainMenu: document.getElementById('main-menu-screen'),
        gameplay: document.getElementById('gameplay-screen'),
        gameOver: document.getElementById('game-over-screen'),
        onlineSearch: document.getElementById('online-search-screen'),
    },
    modals: {
        profile: document.getElementById('profile-modal'),
        modeSelection: document.getElementById('mode-selection-modal'),
    },
    // ... other elements
};

// --- Game Data ---
const Riddles = {
    normal: [ { q: 'آن چیست که پر دارد ولی پرواز نمی‌کند؟', a: 'بالش', options: ['پرنده', 'بالش', 'هواپیما', 'بادبادک'] }, { q: 'آن چیست که هرچه از آن بردارند بزرگتر می‌شود؟', a: 'گودال', options: ['کیسه', 'کوه', 'گودال', 'درخت'] }, { q: 'آن چیست که یک چشم دارد ولی نمی‌بیند؟', a: 'سوزن', options: ['سوزن', 'سیکلوپ', 'دوربین', 'هیولا'] }, { q: 'آن چیست که گردن دارد اما سر ندارد؟', a: 'کوزه', options: ['پیراهن', 'بطری', 'کوزه', 'شیشه'] }, { q: 'آن چیست که روز را آغاز و شب را تمام می‌کند؟', a: 'ر', options: ['آفتاب', 'ماه', 'ر', 'ش'] }, ],
    hard: [ { q: 'آن چیست که وقتی ایستاده است می‌خوابد و وقتی راه می‌رود بیدار است؟', a: 'قطار' }, { q: 'من هیچ بدنی ندارم اما می‌توانم راه بروم. من دهانی ندارم اما می‌توانم حرف بزنم. من کیستم؟', a: 'پژواک' }, { q: 'آن چیست که اگر آن را داشته باشی می‌خواهی به اشتراک بگذاری، و اگر به اشتراک بگذاری دیگر آن را نداری؟', a: 'راز' }, { q: 'چه چیزی همیشه جلوتر از شماست اما هرگز نمی‌توانید آن را بگیرید؟', a: 'آینده' }, { q: 'آن چیست که بدون کلید باز می‌شود؟', a: 'موز' }, ]
};
const BotNames = ['سهیل شاه', 'Makei', 'آریا', 'سارینا', 'کیان', 'مریم'];

// --- User Management (Auth) ---
const auth = {
    DB_KEY: 'chistanGameUsers',
    CURRENT_USER_KEY: 'chistanCurrentUser',
    
    getUsers() {
        return JSON.parse(localStorage.getItem(this.DB_KEY)) || [];
    },
    saveUsers(users) {
        localStorage.setItem(this.DB_KEY, JSON.stringify(users));
    },
    getCurrentUser() {
        const username = localStorage.getItem(this.CURRENT_USER_KEY);
        if (!username) return null;
        const users = this.getUsers();
        return users.find(u => u.username === username);
    },
    register(username, age, password) {
        const users = this.getUsers();
        if (users.find(u => u.username === username)) {
            return { success: false, message: 'این نام کاربری قبلا استفاده شده است.' };
        }
        const newUser = {
            username,
            age,
            password, // NOTE: In a real app, hash the password!
            stats: { highScore: 0, correct: 0, incorrect: 0, totalGames: 0, onlineGames: 0, onlineWins: 0 }
        };
        users.push(newUser);
        this.saveUsers(users);
        return { success: true };
    },
    login(username, password) {
        const users = this.getUsers();
        const user = users.find(u => u.username === username);
        if (user && user.password === password) {
            localStorage.setItem(this.CURRENT_USER_KEY, username);
            return { success: true };
        }
        return { success: false, message: 'نام کاربری یا رمز عبور اشتباه است.' };
    },
    logout() {
        localStorage.removeItem(this.CURRENT_USER_KEY);
        ui.showScreen('auth');
    },
    updateStats(statsToUpdate) {
        let currentUser = this.getCurrentUser();
        if (!currentUser) return;
        
        // Update stats
        for (const key in statsToUpdate) {
            currentUser.stats[key] = (currentUser.stats[key] || 0) + statsToUpdate[key];
        }
        // Check for new high score
        if (game.state.score > currentUser.stats.highScore) {
            currentUser.stats.highScore = game.state.score;
        }

        const users = this.getUsers();
        const userIndex = users.findIndex(u => u.username === currentUser.username);
        if (userIndex !== -1) {
            users[userIndex] = currentUser;
            this.saveUsers(users);
        }
    }
};

// --- UI Management ---
const ui = {
    showScreen(screenName) {
        Object.values(DOM.screens).forEach(screen => screen.style.display = 'none');
        if (DOM.screens[screenName]) {
            DOM.screens[screenName].style.display = 'flex';
        }
    },
    updateHeader() {
        const user = auth.getCurrentUser();
        if (!user) return;
        document.getElementById('menu-username').textContent = user.username;
        document.getElementById('menu-avatar').textContent = user.username.charAt(0).toUpperCase();
        document.getElementById('menu-highscore').textContent = `🚀 بالاترین رکورد: ${user.stats.highScore}`;
    },
    updateProfileModal() {
        const user = auth.getCurrentUser();
        if (!user) return;
        document.getElementById('profile-username').textContent = user.username;
        document.getElementById('profile-age').textContent = user.age;
        document.getElementById('profile-highscore').textContent = user.stats.highScore;
        document.getElementById('profile-correct').textContent = user.stats.correct;
        document.getElementById('profile-incorrect').textContent = user.stats.incorrect;
        document.getElementById('profile-total-games').textContent = user.stats.totalGames;
        document.getElementById('profile-online-games').textContent = user.stats.onlineGames;
        document.getElementById('profile-online-wins').textContent = user.stats.onlineWins;
    },
    showProfileModal() {
        this.updateProfileModal();
        DOM.modals.profile.classList.remove('hidden');
        setTimeout(() => DOM.modals.profile.classList.add('active'), 10);
    },
    hideProfileModal() {
        DOM.modals.profile.classList.remove('active');
        setTimeout(() => DOM.modals.profile.classList.add('hidden'), 400);
    },
    normalizeAnswer: (text) => text.trim().replace(/ی/g, 'ي').replace(/ک/g, 'ك').toLowerCase().replace(/\s/g, ''),
    startFallingLetters() {
        const canvas = document.getElementById('falling-letters-canvas'); if (!canvas) return; const ctx = canvas.getContext('2d');
        const setupCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        setupCanvas();
        const letters = 'ابپتثجچحخدذرزژسشصضطظعغفقکگلمنوهی'; const fontSize = 18; const columns = canvas.width / fontSize;
        const drops = Array.from({ length: columns }).fill(1);
        function draw() {
            ctx.fillStyle = 'rgba(18, 18, 18, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#FFD700'; ctx.font = `${fontSize}px Vazirmatn`;
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
            requestAnimationFrame(draw);
        }
        window.addEventListener('resize', setupCanvas);
        draw();
    }
};

// --- Game Logic ---
const game = {
    state: {},
    timer: null,
    
    resetState() {
        this.state = {
            score: 0,
            lives: 3,
            currentMode: null, // 'old' or 'flash'
            gameType: null, // 'record' or 'online'
            usedRiddleIndices: { normal: [], hard: [] },
            // Online specific
            online: {
                botName: '',
                playerScore: 0,
                botScore: 0,
                round: 1,
                modes: ['flash', 'old'], // Order of rounds
            }
        };
    },
    
    selectGameMode(mode) {
        DOM.modals.modeSelection.classList.add('hidden');
        this.startRecordGame(mode);
    },

    startRecordGame(mode) {
        this.resetState();
        this.state.gameType = 'record';
        this.state.currentMode = mode;
        document.getElementById('online-match-header').classList.add('hidden');
        document.getElementById('lives-count').parentElement.classList.remove('hidden');
        ui.showScreen('gameplay');
        this.loadNextRiddle();
    },

    startOnlineMatch() {
        this.resetState();
        this.state.gameType = 'online';
        ui.showScreen('onlineSearch');
        document.getElementById('opponent-found-text').classList.add('opacity-0');

        setTimeout(() => {
            this.state.online.botName = BotNames[Math.floor(Math.random() * BotNames.length)];
            const opponentText = document.getElementById('opponent-found-text');
            opponentText.textContent = `حریف پیدا شد: ${this.state.online.botName}`;
            opponentText.classList.remove('opacity-0');

            setTimeout(() => {
                this.prepareOnlineRound();
            }, 2000);
        }, 3000);
    },

    prepareOnlineRound() {
        this.state.currentMode = this.state.online.modes[this.state.online.round - 1];
        document.getElementById('lives-count').parentElement.classList.add('hidden');
        const onlineHeader = document.getElementById('online-match-header');
        onlineHeader.classList.remove('hidden');
        document.getElementById('online-bot-name').textContent = this.state.online.botName;
        document.getElementById('online-round-count').textContent = this.state.online.round;
        this.updateOnlineScoreUI();
        ui.showScreen('gameplay');
        this.loadNextRiddle();
    },
    
    updateOnlineScoreUI() {
        document.getElementById('online-player-score').textContent = this.state.online.playerScore;
        document.getElementById('online-bot-score').textContent = this.state.online.botScore;
    },

    loadNextRiddle() {
        const isFlash = this.state.currentMode === 'flash';
        const riddleSource = isFlash ? Riddles.hard : Riddles.normal;
        const usedIndices = isFlash ? this.state.usedRiddleIndices.hard : this.state.usedRiddleIndices.normal;

        if (usedIndices.length === riddleSource.length) usedIndices.length = 0; // Reset if all used
        
        let riddleIndex;
        do {
            riddleIndex = Math.floor(Math.random() * riddleSource.length);
        } while (usedIndices.includes(riddleIndex));
        
        usedIndices.push(riddleIndex);
        const riddle = riddleSource[riddleIndex];
        
        document.getElementById('riddle-question').textContent = riddle.q;
        
        const optionsContainer = document.getElementById('options-container');
        const inputContainer = document.getElementById('input-container');

        if (isFlash) {
            optionsContainer.classList.add('hidden');
            inputContainer.classList.remove('hidden');
            document.getElementById('flash-answer-input').value = '';
            document.getElementById('flash-answer-input').focus();
        } else {
            inputContainer.classList.add('hidden');
            optionsContainer.classList.remove('hidden');
            optionsContainer.innerHTML = '';
            riddle.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full btn-option p-3 bg-gray-700 rounded-lg hover:bg-yellow-400/20';
                button.onclick = () => this.checkAnswer(option);
                optionsContainer.appendChild(button);
            });
        }
        this.startTimer();
    },

    startTimer() {
        clearInterval(this.timer);
        const timerDisplay = document.getElementById('timer-display');
        const timerCount = document.getElementById('timer-count');
        
        if (this.state.gameType === 'record' && this.state.currentMode !== 'flash') {
            timerDisplay.classList.add('hidden');
            return;
        }

        let timeLimit = this.state.gameType === 'online' ? 35 : 15;
        timerCount.textContent = timeLimit;
        timerDisplay.classList.remove('hidden', 'timer-flash');
        
        this.timer = setInterval(() => {
            timeLimit--;
            timerCount.textContent = timeLimit;
            if (timeLimit <= 5) timerDisplay.classList.add('timer-flash');
            if (timeLimit <= 0) {
                this.checkAnswer(null); // Timeout
            }
        }, 1000);
    },

    checkAnswer(selectedAnswer) {
        clearInterval(this.timer);
        const isFlash = this.state.currentMode === 'flash';
        const riddleSource = isFlash ? Riddles.hard : Riddles.normal;
        const usedIndices = isFlash ? this.state.usedRiddleIndices.hard : this.state.usedRiddleIndices.normal;
        const currentRiddle = riddleSource[usedIndices[usedIndices.length - 1]];
        const correctAnswer = currentRiddle.a;

        let playerAnswer = isFlash ? document.getElementById('flash-answer-input').value : selectedAnswer;
        let isCorrect = playerAnswer !== null && ui.normalizeAnswer(playerAnswer) === ui.normalizeAnswer(correctAnswer);
        
        if (isCorrect) {
            this.state.score += 10;
            if (this.state.gameType === 'online') this.state.online.playerScore++;
            auth.updateStats({ correct: 1 });
        } else {
            if (this.state.gameType === 'record') this.state.lives--;
            auth.updateStats({ incorrect: 1 });
        }
        
        // Simulate bot answer in online mode
        if (this.state.gameType === 'online' && Math.random() > 0.3) { // 70% chance bot is correct
             this.state.online.botScore++;
        }
        
        this.updateUI();

        if (this.state.gameType === 'record' && this.state.lives <= 0) {
            setTimeout(() => this.endGame(), 1000);
        } else if (this.state.gameType === 'online') {
             setTimeout(() => this.nextOnlineStep(), 1500);
        } else {
            setTimeout(() => this.loadNextRiddle(), 1000);
        }
    },
    
    nextOnlineStep() {
        if (this.state.online.round < this.state.online.modes.length) {
            this.state.online.round++;
            this.prepareOnlineRound();
        } else {
            this.endGame();
        }
    },
    
    endGame() {
        auth.updateStats({ totalGames: 1 });
        const user = auth.getCurrentUser();
        
        const titleEl = document.getElementById('game-over-title');
        const subtitleEl = document.getElementById('game-over-subtitle');
        const statsEl = document.getElementById('game-over-stats');
        const playAgainBtn = document.getElementById('play-again-btn');

        if (this.state.gameType === 'online') {
            auth.updateStats({ onlineGames: 1 });
            let win = this.state.online.playerScore > this.state.online.botScore;
            let draw = this.state.online.playerScore === this.state.online.botScore;
            
            if (win) {
                 titleEl.textContent = "شما برنده شدید!";
                 titleEl.className = "text-4xl font-black text-green-400";
                 auth.updateStats({ onlineWins: 1 });
            } else if (draw) {
                 titleEl.textContent = "بازی مساوی شد!";
                 titleEl.className = "text-4xl font-black text-yellow-400";
            } else {
                 titleEl.textContent = "شما باختید!";
                 titleEl.className = "text-4xl font-black text-red-400";
            }
            subtitleEl.textContent = `نتیجه نهایی: شما ${this.state.online.playerScore} - ${this.state.online.botScore} ${this.state.online.botName}`;
            statsEl.classList.add('hidden');
            playAgainBtn.textContent = 'بازی آنلاین مجدد';
            playAgainBtn.onclick = () => this.startOnlineMatch();
        } else {
            titleEl.textContent = "بازی تمام شد!";
            titleEl.className = "text-4xl font-black text-red-400";
            subtitleEl.textContent = "";
            statsEl.classList.remove('hidden');
            playAgainBtn.textContent = 'بازی مجدد';
            playAgainBtn.onclick = () => this.startRecordGame(this.state.currentMode);

            document.getElementById('final-score').textContent = this.state.score;
            document.getElementById('final-highscore').textContent = user.stats.highScore;
        }

        ui.showScreen('gameOver');
    },

    updateUI() {
        document.getElementById('game-score').textContent = this.state.score;
        document.getElementById('lives-count').textContent = this.state.lives;
        if(this.state.gameType === 'online') this.updateOnlineScoreUI();
    }
};

// --- Event Listeners & Initialization ---
function init() {
    // Auth Screens
    document.getElementById('go-to-login-btn').addEventListener('click', () => ui.showScreen('login'));
    document.getElementById('go-to-register-btn').addEventListener('click', () => ui.showScreen('register'));
    document.getElementById('back-to-auth-from-login').addEventListener('click', () => ui.showScreen('auth'));
    document.getElementById('back-to-auth-from-register').addEventListener('click', () => ui.showScreen('auth'));

    // Register Logic
    document.getElementById('register-btn').addEventListener('click', () => {
        const user = document.getElementById('register-username').value.trim();
        const age = document.getElementById('register-age').value;
        const pass = document.getElementById('register-password').value;
        const confirmPass = document.getElementById('register-confirm-password').value;
        const errorEl = document.getElementById('register-error');

        if (!user || !age || !pass || !confirmPass) {
            errorEl.textContent = 'لطفا تمام فیلدها را پر کنید.';
            errorEl.classList.remove('hidden');
            return;
        }
        if (pass !== confirmPass) {
            errorEl.textContent = 'رمزهای عبور یکسان نیستند.';
            errorEl.classList.remove('hidden');
            return;
        }
        
        const result = auth.register(user, age, pass);
        if (result.success) {
            // Automatically log in after registration
            const loginResult = auth.login(user, pass);
            if (loginResult.success) {
                ui.updateHeader();
                ui.showScreen('mainMenu');
            }
        } else {
            errorEl.textContent = result.message;
            errorEl.classList.remove('hidden');
        }
    });

    // Login Logic
    document.getElementById('login-btn').addEventListener('click', () => {
        const user = document.getElementById('login-username').value.trim();
        const pass = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        const result = auth.login(user, pass);

        if (result.success) {
            ui.updateHeader();
            ui.showScreen('mainMenu');
        } else {
            errorEl.textContent = result.message;
            errorEl.classList.remove('hidden');
        }
    });
    
    // Main Menu
    document.getElementById('start-game-btn').addEventListener('click', () => DOM.modals.modeSelection.classList.remove('hidden'));
    document.getElementById('start-online-btn').addEventListener('click', () => game.startOnlineMatch());
    document.getElementById('close-mode-selection-btn').addEventListener('click', () => DOM.modals.modeSelection.classList.add('hidden'));

    // Profile
    document.getElementById('profile-header-btn').addEventListener('click', ui.showProfileModal.bind(ui));
    document.getElementById('close-profile-btn').addEventListener('click', ui.hideProfileModal.bind(ui));
    document.getElementById('logout-btn').addEventListener('click', auth.logout);

    // Gameplay
    document.getElementById('flash-submit-btn').addEventListener('click', () => game.checkAnswer());
    document.getElementById('flash-answer-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') game.checkAnswer(); });

    // Game Over
    document.getElementById('back-to-menu-gameover-btn').addEventListener('click', () => ui.showScreen('mainMenu'));


    // Initial Load
    if (auth.getCurrentUser()) {
        ui.updateHeader();
        ui.showScreen('mainMenu');
    } else {
        ui.showScreen('auth');
    }
    
    ui.startFallingLetters();
}

window.onload = init;

</script>
</body>
</html>
